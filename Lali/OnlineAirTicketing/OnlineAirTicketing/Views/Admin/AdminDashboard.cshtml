@{
    ViewBag.Title = "AdminDashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="admin logintitle"><h5 class="title">Welcom Admin</h5><span title="Admin User" class="user-sym glyphicon glyphicon-user"></span></div>
<script>
    $(document).ready(function () {
        $('.success-err-msg').hide();
        $('.success-err-msg-delete').hide();
    });
    
        var changeTheView = function (view) {
            $('.action-div').hide();
            $('.menu').removeClass('active');
            switch (view) {
                case 'add-flight': $('.add-flight-div').show();
                    $('#addFlight').addClass('active');
                    break;
                case 'delete-flight': $('.delete-flight-div').show();
                    $('#deleteFlight').addClass('active');
                    fetchAllFlight();
                    break;
                case 'modify-flight': $('.modify-flight-div').show();
                    $('#modifyFlight').addClass('active');
                    break;
            }
        };


        var fetchAllFlight = function () {
            $.ajax({
                type: "GET",
                url: "/Admin/GetFlights",
                dataType: "json",
                success: function (response) {
                    $('.flight-div').remove();
                    for (var count = 0; count < response.length; count++) {
                        var temp = "<div class=\"flight-div\">\r\n                <span title=\"Delete Flight\" class=\"delete-icon glyphicon glyphicon-remove\"  onclick=\"deleteFlight(" + response[count].flightID + ")\"><\/span>\r\n      "
                        + "          <h3><span>Flight No<\/span>&nbsp;<span>" + response[count].flightNumber + "<\/span><\/h6>\r\n          "
                        + "   <div><div class=\"detail\">   <h6><span>Origin<\/span>&nbsp;<span>" + response[count].origin + "<\/span><\/h6>\r\n               "
                        + " <h6><span>Destination<\/span>&nbsp;<span>" + response[count].destination + "<\/span><\/h6><\/div>\r\n             "
                        + "  <div class=\"detail\"> <h6><span>Departure Time<\/span>&nbsp;<span>" + response[count].departTime + "<\/span><\/h6>\r\n  "
                        + "<h6><span>Arrival Time<\/span>&nbsp;<span>" + response[count].arrivalTime + "<\/span><\/h6><\/div>\r\n            <\/div>";

                        $('.flight-list-div').append(temp);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {

                    console.log(xhr.responseText);
                }
            });
        }

        var deleteFlight = function(flightID)
        {
            var data = {};
            data.flightID = flightID;
            $.ajax({
                type: "POST",
                url: "/Admin/DeleteFlight",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json",
                success: function (response) {
                    if (response.returnCode == 1) {

                        $('.success-err-msg-delete').show().delay(5000).fadeOut();
                        $('.success-err-msg-delete').text('Flight Deleted Successfully');
                        fetchAllFlight();
                    }
                    else {
                        $('.success-err-msg-delete').show().delay(5000).fadeOut();
                        $('.success-err-msg-delete').text('Due to some technical issues, flight cannot be deleted now.');
                        console.log(response);
                    }
                    
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    $('.success-err-msg-delete').show().delay(5000).fadeOut();
                    $('.success-err-msg-delete').text('Due to some technical issues, flight cannot be deleted now.');
                    console.log(xhr.responseText);
                }
            });
        }

        var addFlightLeg = function () {
            var flightlegNo = $('.flightleg-no');
            var id;
            if (flightlegNo && flightlegNo.length > 0) {
                var flightLegId = $('.flightleg-no').last().attr('id');
                id = flightLegId.split('-')[1];
                id = parseInt(id) + 1;
            }
            else {
                id = 1;
            }
            var flightLegTemplate = " <div class=\"flight-leg-div\">\r\n                <div class=\"row\">\r\n                    <div class=\"col-xs-2\">\r\n                        <label id=\"flightleg-" + id + "\" class=\"flightleg-no\">Flight Leg " + id + "<\/label>\r\n                    <\/div>\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>FlightLeg Number<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"flightlegNum\" \/><\/div>\r\n                    <\/div>\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>Duration (hh:mm format)<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"duration\" \/><\/div>\r\n                    <\/div>\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>Departure Time (hh:mm format)<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"departtime\" \/><\/div>\r\n                    <\/div>\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>Arrival Time (hh:mm format)<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"arrivaltime\" \/><\/div>\r\n                    <\/div>\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>Base Fare (Rs)<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"basefare\" \/><\/div>\r\n                    <\/div>\r\n                <\/div>\r\n                <div class=\"row\">\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>Departing Airport<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"departingairport\" \/><\/div>\r\n                    <\/div>\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>Arrival Airport<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"arrivalairport\" \/><\/div>\r\n                    <\/div>\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>Origin<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"legorigin\" \/><\/div>\r\n                    <\/div>\r\n                    <div class=\"col-xs-2\">\r\n                        <div class=\"row\"><span>Destination<\/span><\/div>\r\n                        <div class=\"row\"><input type=\"text\" id=\"legdestination\" \/><\/div>\r\n                <\/div>\r\n        <div class=\"col-xs-2\">\r\n                        <button onclick=\"removeFlightLeg("+ id +")\" class=\"btn btn-xs btn-primary\"><span class=\"glyphicon glyphicon-minus-sign\"><\/span>&nbsp;&nbsp;<span>Remove Flight Leg<\/span><\/button>\r\n                    <\/div>                   \r\n                <\/div>\r\n              <hr class=\"leg-template-end\" \/>\r\n            <\/div>";
            $('.flight-leg-placeholder').append(flightLegTemplate);
            
        }


        var addFlight = function () {
            var flightDetail = {};
            flightDetail.flightNumber = $('#flightNum').val();
            flightDetail.origin = $('#origin').val();
            flightDetail.destination = $('#destination').val();
            flightDetail.distance = parseFloat($('#distance').val());
            flightDetail.noOfLegs = parseInt($('#legnum').val());
            flightDetail.flightLegs = [];
            if (flightDetail.noOfLegs > 0) {
                var flightlegNo = $('.flightleg-no');
                if (flightlegNo && flightlegNo.length > 0 && flightlegNo.length == flightDetail.noOfLegs && flightDetail.noOfLegs >= 1) {
                    for (var count = 1; count <= flightDetail.noOfLegs; count++) {
                        var flightlegDiv = $("#flightleg-" + count).closest('.flight-leg-div');
                        var flightLeg = {};
                        flightLeg.flightlegNo = $(flightlegDiv).find("#flightlegNum").val();
                        flightLeg.duration = $(flightlegDiv).find("#duration").val();
                        flightLeg.departTime = $(flightlegDiv).find("#departtime").val();
                        flightLeg.arrivalTime = $(flightlegDiv).find("#arrivaltime").val();
                        flightLeg.baseFare = parseFloat($(flightlegDiv).find("#basefare").val());
                        flightLeg.departingAirport = $(flightlegDiv).find("#departingairport").val();
                        flightLeg.arrivalAirport = $(flightlegDiv).find("#arrivalairport").val();
                        flightLeg.legOrigin = $(flightlegDiv).find("#legorigin").val();
                        flightLeg.legDestination = $(flightlegDiv).find("#legdestination").val();
                        flightDetail.flightLegs.push(flightLeg);
                    }
                }
                else {
                    $('.success-err-msg').show().delay(5000).fadeOut();
                    $('.success-err-msg').text('Please provide details for all the flight legs. Flight should have atleast one flight leg');
                    document.body.scrollTop = document.documentElement.scrollTop = 0;
                    return;
                }
            }
            console.log(flightDetail);
            $.ajax({
                type: "POST",
                url: "/Admin/AddFlight",
                data: JSON.stringify(flightDetail),
                dataType: "json",
                contentType: "application/json",
                success: function (response) {
                    $('.success-err-msg').show().delay(5000).fadeOut();
                    $('.success-err-msg').text('Flight Details added. Flight ID :' + response.flightID);
                    document.body.scrollTop = document.documentElement.scrollTop = 0;
                    console.log(response);
                    var elements = document.getElementsByTagName("input");
                    //clearing all elements.
                    for (var ii = 0; ii < elements.length; ii++) {
                        if (elements[ii].type == "text") {
                            elements[ii].value = "";
                        }
                    }
                    $('.flight-leg-div').remove();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    $('.success-err-msg').show().delay(5000).fadeOut();
                    $('.success-err-msg').text('Error while submitting data. Please check data and submit again');
                    document.body.scrollTop = document.documentElement.scrollTop = 0;
                    console.log(xhr.responseText);
                }
            });
        }

        var removeFlightLeg = function (removeLegID) {
            var flightlegNo = $('.flightleg-no');
            var id;
            if (flightlegNo && flightlegNo.length > 0) {
                var flightLegId = $('.flightleg-no').last().attr('id');
                id = flightLegId.split('-')[1];
                if (id == removeLegID) {
                    $("#" + flightLegId).closest('.flight-leg-div').remove();
                }
                else {
                    $('.success-err-msg').show().delay(5000).fadeOut();
                    $('.success-err-msg').text('Remove the last Flight Leg first.');
                    document.body.scrollTop = document.documentElement.scrollTop = 0;
                }
            }
        }

</script>

<div class="row menu-box">
    <div class="navigation">
        <div class="menu active" id="addFlight"  onclick="changeTheView('add-flight')"><span class="glyphicon glyphicon-plus">&nbsp;</span><span class="title">Add Flight</span></div>
        <div class="menu" id="deleteFlight" onclick="changeTheView('delete-flight')"><span class="glyphicon glyphicon-remove">&nbsp;</span><span class="title" >Delete Flight</span></div>
        <div class="menu" id="modifyFlight" onclick="changeTheView('modify-flight')"><span class="glyphicon glyphicon-pencil">&nbsp;</span><span class="title" >Modify Flight</span></div>
    </div>
</div>

<div class="row action-template">
    <div class="row add-flight-div action-div">
        <div class="row alert alert-info success-err-msg"></div>
        <div class="row">
            <div class="col-xs-2">
                <div class="row"><span>Flight Number</span></div>
                <div class="row">
                    <input type="text" id="flightNum" />
                </div>
            </div>
            <div class="col-xs-2">
                <div class="row"><span>Origin</span></div>
                <div class="row">
                    <input type="text" id="origin" />
                </div>
            </div>
            <div class="col-xs-2">
                <div class="row"><span>Destination</span></div>
                <div class="row">
                    <input type="text" id="destination" />
                </div>
            </div>
            <div class="col-xs-2">
                <div class="row"><span>Distance (Kms)</span></div>
                <div class="row">
                    <input type="text" id="distance" />
                </div>
            </div>
            <div class="col-xs-2">
                <div class="row"><span>Number of Legs</span></div>
                <div class="row">
                    <input type="text" id="legnum" />
                </div>
            </div>
            <div class="col-xs-2">
                <div class="row">
                    <button onclick="addFlightLeg()" class="btn btn-xs btn-primary"><span class="glyphicon glyphicon-plus-sign"></span>&nbsp;&nbsp;<span>Add Flight Leg</span></button>
                </div>
                <div class="row">
                    <button class="btn btn-xs btn-primary" onclick="addFlight()"><span class="glyphicon glyphicon-plus-sign"></span>&nbsp;&nbsp;<span>Add Flight</span></button>
                </div>
                
            </div>
        </div>
        <div class="row flight-leg-placeholder">
        </div>
        <div class="row">
            <div class="col-xs-10"></div>
                
        </div>
    </div>
    <div class="row delete-flight-div action-div">
        <div class="row alert alert-info success-err-msg-delete"></div>
        <div class="flight-list-div">
            
        </div>
    </div>
    <div class="row modify-flight-div action-div"></div>
</div>
